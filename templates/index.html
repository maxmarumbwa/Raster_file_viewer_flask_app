<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rainfall Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f6f8;
        }

        h1 {
            color: #1f77b4;
        }

        .form-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-container label {
            margin-right: 5px;
            font-weight: bold;
        }

        .form-container input,
        .form-container select {
            margin-right: 10px;
            padding: 4px;
        }

        .form-container button {
            margin: 2px;
            padding: 6px 12px;
            background: #1f77b4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-container button.active {
            background: #ff7f0e;
        }

        .dashboard {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #map {
            flex: 1 1 500px;
            height: 400px;
            border: 2px solid #1f77b4;
            border-radius: 8px;
        }

        #chart-container {
            flex: 1 1 500px;
            border: 2px solid #1f77b4;
            border-radius: 8px;
            padding: 10px;
            background: white;
            position: relative;
        }

        .table-wrapper {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background: #1f77b4;
            color: white;
            position: sticky;
            top: 0;
        }

        /* Loading spinner */
        #chart-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1f77b4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Animation controls */
        .animation-controls {
            margin-top: 10px;
        }

        .animation-controls button {
            padding: 6px 12px;
            margin-right: 5px;
        }

        .animation-controls input[type="range"] {
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <h1>Rainfall Dashboard – Event vs Baseline (Dekadal)</h1>

    <div class="form-container">
        <label>Rainfall Date:</label>
        <input type="date" id="date" value="2005-03-21">
        <button onclick="loadRainfallLayer()">Load Rainfall Base</button>
        <br><br>

        <label>Start:</label>
        <input type="date" id="start" value="2001-05-01">
        <label>End:</label>
        <input type="date" id="end" value="2002-06-21">
        <br><br>

        <label>Map Layer:</label>
        <button onclick="showLayer('base')">Base Rainfall</button>
        <button onclick="showLayer('anom')">Anomaly</button>
        <br><br>

        <!-- Admin dropdown -->
        <label>Select Admin Region:</label>
        <select id="admin-select" onchange="onAdminChange()">
            <option value="">-- Select Region --</option>
            <!-- Options populated dynamically -->
        </select>
    </div>

    <div class="dashboard">
        <div id="map"></div>
        <div id="chart-container">
            <h3>Click on map to generate rainfall chart</h3>
            <div id="chart-loader">
                <div class="spinner"></div>
            </div>
            <canvas id="rainChart"></canvas>
        </div>
    </div>

    <!-- Animation control -->
    <div class="animation-controls">
        <button id="play-btn">▶ Play Animation</button>
        <button id="stop-btn">⏹ Stop</button>
        <label>Speed:</label>
        <input type="range" id="speed-slider" min="100" max="2000" value="500">
        <span id="current-date"></span>
    </div>

    <h3>Admin Rainfall (Event vs LTA)</h3>
    <div class="table-wrapper">
        <table id="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Dekad</th>
                    <th>Event (mm)</th>
                    <th>LTA (mm)</th>
                    <th>Anomaly</th>
                    <th>% Normal</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        /* ================= MAP ================= */
        const map = L.map('map').setView([-18.7, 29.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const bounds = [[-35.0044, 10.9955], [-7.9955, 41.0044]];

        let rainfallLayer, anomalyLayer;
        let currentLayer = "base"; // default
        let chart;
        let adminGeoJSON;
        let animationInterval = null;

        /* ================= LOAD BASE RAINFALL ================= */
        function loadRainfallLayer(date = null) {
            if (!date) date = document.getElementById('date').value;
            if (rainfallLayer) map.removeLayer(rainfallLayer);
            if (currentLayer !== "base") return;
            rainfallLayer = L.imageOverlay(`/api/classified_rainfall_tif/${date}`, bounds, { opacity: 0.6 }).addTo(map);
            document.getElementById('current-date').textContent = date;
        }

        /* ================= LOAD ANOMALY ================= */
        function loadAnomalyLayer() {
            const date = document.getElementById('date').value;
            if (anomalyLayer) map.removeLayer(anomalyLayer);
            if (currentLayer !== "anom") return;
            anomalyLayer = L.imageOverlay(`/api/classified_dekadal_anomaly/${date}`, bounds, { opacity: 0.6 }).addTo(map);
        }

        /* ================= LAYER TOGGLE ================= */
        function showLayer(layerType) {
            currentLayer = layerType;
            if (rainfallLayer) map.removeLayer(rainfallLayer);
            if (anomalyLayer) map.removeLayer(anomalyLayer);

            if (layerType === "base") loadRainfallLayer();
            if (layerType === "anom") loadAnomalyLayer();

            // Button styling
            document.querySelectorAll(".form-container button").forEach(btn => btn.classList.remove("active"));
            if (layerType === "base") document.querySelector("button[onclick=\"showLayer('base')\"]").classList.add("active");
            if (layerType === "anom") document.querySelector("button[onclick=\"showLayer('anom')\"]").classList.add("active");
        }

        /* ================= POPULATE ADMIN DROPDOWN AND MAP ================= */
        fetch("/static/data/zim_admin1.geojson")
            .then(r => r.json())
            .then(gjson => {
                adminGeoJSON = gjson;

                // Populate dropdown
                const select = document.getElementById("admin-select");
                gjson.features.forEach(f => {
                    const name = f.properties.ADM1_EN;
                    const option = document.createElement("option");
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });

                // Add to map
                L.geoJSON(gjson, {
                    style: { color: "#FF5733", weight: 2, fillOpacity: 0.1 },
                    onEachFeature: (f, l) => {
                        l.on("click", () => {
                            select.value = f.properties.ADM1_EN; // sync dropdown
                            loadAdminData(f.properties.ADM1_EN);
                        });
                    }
                }).addTo(map);
            });

        /* ================= HANDLE DROPDOWN CHANGE ================= */
        function onAdminChange() {
            const adm = document.getElementById("admin-select").value;
            if (adm) loadAdminData(adm);
        }

        /* ================= LOAD ADMIN DATA ================= */
        function loadAdminData(adm) {
            if (!adm) return;
            const s = document.getElementById('start').value;
            const e = document.getElementById('end').value;
            document.getElementById('chart-loader').style.display = 'block';

            fetch(`/api/event_vs_lta_range?start_date=${s}&end_date=${e}&adm1_name=${adm}`)
                .then(r => r.json())
                .then(json => {
                    drawChart(json.data, adm);
                    drawTable(json.data);
                    document.getElementById('chart-loader').style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('chart-loader').style.display = 'none';
                });
        }

        /* ================= CHART ================= */
        function drawChart(data, adm) {
            const labels = data.map(d => d.date);
            const eventVals = data.map(d => d.event_mm);
            const ltaVals = data.map(d => d.baseline_mm);

            if (chart) chart.destroy();

            chart = new Chart(rainChart, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        { label: `${adm} Event`, data: eventVals, borderWidth: 2, tension: 0.3 },
                        { label: "Baseline (LTA)", data: ltaVals, borderDash: [6, 4], borderWidth: 2, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: "top" } },
                    scales: { y: { title: { display: true, text: "Rainfall (mm)" } } }
                }
            });
        }

        /* ================= TABLE ================= */
        function drawChart(data, adm) {
            const labels = data.map(d => d.date);
            const eventVals = data.map(d => d.event_mm);
            const ltaVals = data.map(d => d.baseline_mm);

            // Calculate cumulative rainfall
            let cumulative = 0;
            const cumulativeData = data.map(d => {
                cumulative += d.event_mm;
                return cumulative;
            });

            if (chart) chart.destroy();

            chart = new Chart(rainChart, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        { label: `${adm} Event`, data: eventVals, borderWidth: 2, tension: 0.3, yAxisID: 'y' },
                        { label: "Baseline (LTA)", data: ltaVals, borderDash: [6, 4], borderWidth: 2, tension: 0.3, yAxisID: 'y' },
                        { label: `${adm} Cumulative`, data: cumulativeData, borderColor: '#2ca02c', borderWidth: 2, tension: 0.3, fill: false, yAxisID: 'y2' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "top" }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Rainfall (mm)' }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Cumulative Rainfall (mm)' },
                            grid: { drawOnChartArea: false } // avoid grid overlap
                        }
                    }
                }
            });
        }


        /* ================= DEKAD ANIMATION ================= */
        function generateDekadDates(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const dates = [];

            let year = start.getFullYear();
            let month = start.getMonth();

            while (true) {
                for (const day of [1, 11, 21]) {
                    const d = new Date(year, month, day);
                    if (d >= start && d <= end) {
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const dd = String(d.getDate()).padStart(2, '0');
                        dates.push(`${y}-${m}-${dd}`);
                    }
                }
                month++;
                if (month > 11) {
                    month = 0;
                    year++;
                }
                if (new Date(year, month, 1) > end) break;
            }

            return dates;
        }

        document.getElementById('play-btn').addEventListener('click', () => {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            if (!start || !end) return alert("Please select start and end dates");

            const dates = generateDekadDates(start, end);
            let index = 0;

            if (animationInterval) clearInterval(animationInterval);
            animationInterval = setInterval(() => {
                loadRainfallLayer(dates[index]);
                index++;
                if (index >= dates.length) index = 0;
            }, document.getElementById('speed-slider').value);
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            if (animationInterval) clearInterval(animationInterval);
            animationInterval = null;
        });

        /* ================= INIT ================= */
        loadRainfallLayer();
    </script>
</body>

</html>