<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rainfall Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
        h1 { color: #1f77b4; margin-bottom: 15px; }
        .form-container { margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);}
        label { margin-right: 10px; }
        input { margin-right: 20px; padding: 5px; }
        button { padding: 5px 15px; background: #1f77b4; color: white; border: none; border-radius: 4px; cursor: pointer;}
        button:hover { background: #155d8b; }

        /* Dashboard layout */
        .dashboard {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        #map { flex: 1; height: 400px; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);}
        #chart-container { flex: 1; }
        canvas { width: 100%; height: 100%; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);}

        /* Scrollable table */
        .table-wrapper {
            max-height: 300px; /* Adjust height to fit your page */
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: center;
            word-wrap: break-word;
        }
        th { background-color: #1f77b4; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Rainfall Dashboard</h1>

    <div class="form-container">
        <label for="date">Rainfall Base Date:</label>
        <input type="date" id="date" value="2005-03-21">
        <button onclick="loadRainfallLayer()">Load Rainfall Base</button>
        <br><br>
        <label for="start">Start Date:</label>
        <input type="date" id="start" value="2001-05-01">
        <label for="end">End Date:</label>
        <input type="date" id="end" value="2002-06-21">
    </div>

    <div class="dashboard">
        <div id="map"></div>
        <div id="chart-container">
            <canvas id="rainChart"></canvas>
        </div>
    </div>

    <div>
        <h3>Admin Rainfall Data</h3>
        <div class="table-wrapper">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Mean (mm)</th>
                        <th>Min (mm)</th>
                        <th>Max (mm)</th>
                        <th>Std (mm)</th>
                        <th>Pixel Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
    const map = L.map('map').setView([-18.7, 29.5], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const bounds = [
        [-35.00446428571232, 10.995535714285715],
        [-7.995535714285042, 41.00446428571284]
    ];

    let rainfallLayer = null;
    let adminLayer = null;
    let chart = null;

    // Track selected provinces
    const selectedProvinces = {};
    const colorPalette = [
        "#1f77b4", "#d62728", "#2ca02c", "#9467bd",
        "#ff7f0e", "#8c564b", "#e377c2"
    ];
    let colorIndex = 0;

    function loadRainfallLayer() {
        const date = document.getElementById('date').value;
        const imgUrl = `/api/classified_rainfall_tif/${date}`;
        if (rainfallLayer) map.removeLayer(rainfallLayer);
        rainfallLayer = L.imageOverlay(imgUrl, bounds, { opacity: 0.6 }).addTo(map);
        map.fitBounds(bounds);
    }

    // Initialize chart
    function initChart() {
        const ctx = document.getElementById('rainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Rainfall Comparison by Province' }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Rainfall (mm)' } }
                }
            }
        });
    }

    function updateTable() {
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = "";

        Object.values(selectedProvinces).forEach(p => {
            p.daily.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${d.date}</td>
                    <td>${p.name}</td>
                    <td>${d.mean_mm.toFixed(2)}</td>
                    <td>${d.min_mm.toFixed(2)}</td>
                    <td>${d.max_mm.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        });
    }

    function toggleProvince(feature, layer) {
        const admName = feature.properties.ADM1_EN;

        // REMOVE province
        if (selectedProvinces[admName]) {
            delete selectedProvinces[admName];
            chart.data.datasets = chart.data.datasets.filter(d => d.label !== admName);
            layer.setStyle({ fillOpacity: 0.1, weight: 2 });
            chart.update();
            updateTable();
            return;
        }

        // ADD province
        const color = colorPalette[colorIndex++ % colorPalette.length];
        layer.setStyle({ fillOpacity: 0.4, weight: 3, color });

        const start = document.getElementById('start').value;
        const end = document.getElementById('end').value;

        fetch(`/api/rainfall_polygon_range?start_date=${start}&end_date=${end}&adm1_name=${admName}`)
            .then(res => res.json())
            .then(json => {
                selectedProvinces[admName] = {
                    name: admName,
                    color: color,
                    daily: json.daily
                };

                // Update chart labels (once)
                if (chart.data.labels.length === 0) {
                    chart.data.labels = json.daily.map(d => d.date);
                }

                chart.data.datasets.push({
                    label: admName,
                    data: json.daily.map(d => d.mean_mm),
                    borderColor: color,
                    backgroundColor: color + "33",
                    tension: 0.3,
                    fill: false
                });

                chart.update();
                updateTable();
            });
    }

    // Load admin boundaries
    fetch("/static/data/zim_admin1.geojson")
        .then(resp => resp.json())
        .then(data => {
            adminLayer = L.geoJSON(data, {
                style: {
                    color: "#333",
                    weight: 2,
                    fillOpacity: 0.1
                },
                onEachFeature: (feature, layer) => {
                    layer.on('click', () => toggleProvince(feature, layer));
                }
            }).addTo(map);
            map.fitBounds(adminLayer.getBounds());
        });

    initChart();
    loadRainfallLayer();
</script>

</body>
</html>
