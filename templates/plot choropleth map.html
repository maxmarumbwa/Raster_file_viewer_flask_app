<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dekadal Rainfall Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        #map { height: 600px; border-radius: 8px; }
        .controls { margin-bottom: 10px; }
        .legend { background: white; padding: 10px; line-height: 1.5em; box-shadow: 0 3px 6px rgba(0,0,0,0.2); border-radius: 5px; }
        .legend div { display: flex; align-items: center; }
        .legend-color { width: 20px; height: 20px; margin-right: 5px; }
        select, input { margin-right: 10px; padding: 3px; }
    </style>
</head>
<body>
<h2>Dekadal Rainfall Map (Event_mm)</h2>

<div class="controls">
    Year: 
    <input type="number" id="year" value="2001" min="2000" max="2025">
    Month: 
    <select id="month">
        <option value="01">Jan</option>
        <option value="02">Feb</option>
        <option value="03" selected>Mar</option>
        <option value="04">Apr</option>
        <option value="05">May</option>
        <option value="06">Jun</option>
        <option value="07">Jul</option>
        <option value="08">Aug</option>
        <option value="09">Sep</option>
        <option value="10">Oct</option>
        <option value="11">Nov</option>
        <option value="12">Dec</option>
    </select>
    Dekad: 
    <select id="dekad">
        <option value="01">01</option>
        <option value="11" selected>11</option>
        <option value="21">21</option>
    </select>
    <button onclick="loadMap()">Load Map</button>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([-18.7, 29.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let adminLayer;

// Color function for event_mm
function getColor(d) {
    return d > 50 ? "#08306b" :
           d > 25 ? "#2171b5" :
           d > 10 ? "#4292c6" :
           d > 0  ? "#6baed6" :
                     "#ccc";
}

// Style for each feature
function styleFeature(feature) {
    return {
        color: "#333",
        weight: 1,
        fillOpacity: 0.7,
        fillColor: feature.properties.event_mm != null ? getColor(feature.properties.event_mm) : "#ccc"
    };
}

function loadMap() {
    const year = document.getElementById('year').value;
    const month = document.getElementById('month').value;
    const dekad = document.getElementById('dekad').value;

    // Construct date for API
    let day = dekad;
    const dateStr = `${year}-${month}-${day}`;

    fetch("/static/data/zim_admin1.geojson")
    .then(r => r.json())
    .then(gdf => {
        const promises = gdf.features.map(f => {
            const adm = f.properties.ADM1_EN;
            return fetch(`/api/event_vs_lta_range?start_date=${dateStr}&end_date=${dateStr}&adm1_name=${adm}`)
                .then(r => r.json())
                .then(data => {
                    const record = data.data[0];
                    f.properties.event_mm = record ? record.event_mm : null;
                });
        });

        Promise.all(promises).then(() => {
            if(adminLayer) map.removeLayer(adminLayer);

            adminLayer = L.geoJSON(gdf, {
                style: styleFeature,
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(
                        `<b>${feature.properties.ADM1_EN}</b><br>
                        Event Rainfall: ${feature.properties.event_mm != null ? feature.properties.event_mm.toFixed(2) + ' mm' : 'N/A'}`
                    );
                }
            }).addTo(map);

            map.fitBounds(adminLayer.getBounds());
            addLegend();
        });
    });
}

function addLegend() {
    if(document.querySelector(".legend")) document.querySelector(".legend").remove();

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const grades = [0, 10, 25, 50];
        grades.forEach((g,i) => {
            div.innerHTML +=
                `<div><span class="legend-color" style="background:${getColor(g+1)}"></span>${grades[i]}${grades[i+1] ? '&ndash; '+grades[i+1] : '+'} mm</div>`;
        });
        return div;
    };
    legend.addTo(map);
}

// Initial load
loadMap();
</script>
</body>
</html>
