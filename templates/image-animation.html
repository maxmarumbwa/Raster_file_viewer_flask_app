<!DOCTYPE html>
<html>
<head>
    <title>NDVI / Rainfall</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #m {height:100vh;}
        #datePicker {
            position:absolute;
            top:10px;
            left:10px;
            z-index:1100;
            background:white;
            padding:5px 8px;
            border-radius:4px;
            box-shadow:0 0 5px rgba(0,0,0,0.3);
        }
        .animation-controls {
            position:absolute;
            top:20px;
            left:50%;
            transform:translateX(-50%);
            z-index:1100;
            background:white;
            padding:8px 12px;
            border-radius:4px;
            box-shadow:0 0 5px rgba(0,0,0,0.3);
            font-size:12px;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .animation-controls button {
            padding:4px 8px;
            cursor:pointer;
            border:1px solid #ccc;
            border-radius:3px;
            background:#f8f9fa;
            font-size:12px;
        }
        .animation-controls button:hover {
            background:#e9ecef;
        }
        .animation-controls input[type="range"] {
            width:100px;
        }
        #current-date {
            min-width:100px;
            font-weight:bold;
            text-align:center;
        }
    </style>
</head>

<body>
<div id="m"></div>

<!-- Animation Controls -->
<div class="animation-controls">
    <button id="play-btn">▶ Play Animation</button>
    <button id="stop-btn">⏹ Stop</button>
    <input type="range" id="speed-slider" min="100" max="2000" value="500">
    <span id="current-date">2001-12-11</span>
</div>

<!-- Simple date input -->
<div id="dateControl"
     style="
        position:absolute;
        top:20px;
        right:50px;
        z-index:1100;
        background:white;
        padding:8px;
        border-radius:4px;
        box-shadow:0 0 5px rgba(0,0,0,0.3);
        font-size:12px;
     ">
  <select id="yearSel"></select>
  <select id="monthSel"></select>
  <select id="daySel"></select>
</div>

<!-- Legend Container -->
<div id="legend"
     style="
        position:absolute;
        bottom:20px;
        right:40px;
        background:white;
        padding:10px;
        border-radius:5px;
        box-shadow:0 0 10px rgba(0,0,0,0.2);
        z-index:1000;
        font-size:12px;
        line-height:1.4;
     ">
  <strong>Rainfall (mm)</strong>

  <div style="margin-top:6px;">
    <div style="display:flex; align-items:center;">
      <span style="width:18px;height:12px;background:#deebf7;display:inline-block;margin-right:6px;"></span>
      0 – 25 (Very Low)
    </div>
    <div style="display:flex; align-items:center;">
      <span style="width:18px;height:12px;background:#9ecae1;display:inline-block;margin-right:6px;"></span>
      25 – 75 (Low)
    </div>
    <div style="display:flex; align-items:center;">
      <span style="width:18px;height:12px;background:#3182bd;display:inline-block;margin-right:6px;"></span>
      75 – 150 (Moderate)
    </div>
    <div style="display:flex; align-items:center;">
      <span style="width:18px;height:12px;background:#08306b;display:inline-block;margin-right:6px;"></span>
      150 – 250 (High)
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('m').setView([-18.7, 29.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

// Hardcoded Zimbabwe bounds
const zimBounds = L.latLngBounds([[-35.004, 10.995], [-7.995, 41.004]]);

let rainfallLayer = L.imageOverlay(
    'http://localhost:5000/api/classified_rainfall_tif/2001-12-11',
    zimBounds,
    {opacity:0.7}
).addTo(map);

// Load admin boundaries
fetch('/static/data/zim_admin1.geojson')
    .then(resp => resp.json())
    .then(data => {
        L.geoJSON(data, {
            style: {color:'#FF0000', weight:1, fillOpacity:0},
            onEachFeature: (feature, layer) => {
                if(feature.properties && feature.properties.ADM1_EN){
                    layer.bindTooltip(feature.properties.ADM1_EN);
                }
            }
        }).addTo(map);
    });

/* -----------------------------
   Populate dropdowns
------------------------------*/
const yearSel = document.getElementById("yearSel");
const monthSel = document.getElementById("monthSel");
const daySel = document.getElementById("daySel");

// Years (adjust range as needed)
for (let y = 2000; y <= 2025; y++) {
  yearSel.add(new Option(y, y));
}

// Months
for (let m = 1; m <= 12; m++) {
  const mm = String(m).padStart(2, "0");
  monthSel.add(new Option(mm, mm));
}

// Fixed days: 01, 11, 21
["01", "11", "21"].forEach(d => {
  daySel.add(new Option(d, d));
});

// Default selection
yearSel.value = "2001";
monthSel.value = "12";
daySel.value = "11";

/* -----------------------------
   Rainfall layer handling
------------------------------*/
function loadRainfall(dateStr = null) {
  if (!dateStr) {
    dateStr = `${yearSel.value}-${monthSel.value}-${daySel.value}`;
  }
  const url = `http://localhost:5000/api/classified_rainfall_tif/${dateStr}`;

  if (rainfallLayer) map.removeLayer(rainfallLayer);
  rainfallLayer = L.imageOverlay(url, zimBounds, { opacity: 0.7 }).addTo(map);
  
  // Update current date display
  document.getElementById('current-date').textContent = dateStr;
  
  // Also update dropdowns to match
  const [year, month, day] = dateStr.split('-');
  yearSel.value = year;
  monthSel.value = month;
  daySel.value = day;
}

// Reload when any dropdown changes
yearSel.onchange = () => loadRainfall();
monthSel.onchange = () => loadRainfall();
daySel.onchange = () => loadRainfall();

// Initial load
loadRainfall();

/* -----------------------------
   Animation functionality
------------------------------*/
let animationInterval;
let currentAnimationIndex = 0;

// Generate date array for animation (adjust as needed)
const dates = [];
for (let year = 2000; year <= 2025; year++) {
  for (let month = 1; month <= 12; month++) {
    const mm = String(month).padStart(2, "0");
    // Add all three dekads for each month
    dates.push(`${year}-${mm}-01`);
    dates.push(`${year}-${mm}-11`);
    dates.push(`${year}-${mm}-21`);
  }
}

function animateRainfall() {
  stopAnimation(); // Clear any existing interval
  
  animationInterval = setInterval(() => {
    if (currentAnimationIndex >= dates.length) {
      currentAnimationIndex = 0; // Loop back to beginning
    }
    
    const currentDate = dates[currentAnimationIndex];
    loadRainfall(currentDate);
    
    currentAnimationIndex++;
  }, document.getElementById('speed-slider').value);
}

function stopAnimation() {
  if (animationInterval) {
    clearInterval(animationInterval);
    animationInterval = null;
  }
}

// Event listeners for animation controls
document.getElementById('play-btn').addEventListener('click', animateRainfall);
document.getElementById('stop-btn').addEventListener('click', stopAnimation);

// Update animation speed when slider changes
document.getElementById('speed-slider').addEventListener('input', function() {
  // If animation is running, restart it with new speed
  if (animationInterval) {
    animateRainfall();
  }
});

// Also update speed slider value display (optional)
const speedSlider = document.getElementById('speed-slider');
speedSlider.addEventListener('input', function() {
  // You could show the speed value if desired
  // console.log('Animation speed:', this.value, 'ms');
});
</script>
</body>
</html>