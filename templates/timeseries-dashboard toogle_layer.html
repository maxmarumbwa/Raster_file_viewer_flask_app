<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rainfall Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
h1 { color: #1f77b4; }

.form-container { 
    background: white; 
    padding: 15px; 
    border-radius: 8px; 
    margin-bottom: 20px; 
}

.form-container label { margin-right: 5px; font-weight: bold; }
.form-container input { margin-right: 10px; padding: 4px; }
.form-container button {
    margin: 2px;
    padding: 6px 12px;
    background: #1f77b4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.form-container button.active { background: #ff7f0e; }

.dashboard { display: flex; gap: 20px; flex-wrap: wrap; }
#map { flex: 1 1 500px; height: 400px; border: 2px solid #1f77b4; border-radius: 8px; }
#chart-container { flex: 1 1 500px; border: 2px solid #1f77b4; border-radius: 8px; padding: 10px; background: white; position: relative; }

.table-wrapper {
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    margin-top: 20px;
}

table { width: 100%; border-collapse: collapse; }
th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
th { background: #1f77b4; color: white; position: sticky; top: 0; }

/* Loading spinner */
#chart-loader {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    display: none;
    z-index: 10;
}

.spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #1f77b4;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
}
</style>
</head>

<body>
<h1>Rainfall Dashboard â€“ Event vs Baseline (Dekadal)</h1>

<div class="form-container">
    <label>Rainfall Date:</label>
    <input type="date" id="date" value="2005-03-21">
    <button onclick="loadRainfallLayer()">Load Rainfall Base</button>
    <br><br>

    <label>Start:</label>
    <input type="date" id="start" value="2001-05-01">
    <label>End:</label>
    <input type="date" id="end" value="2002-06-21">
    <br><br>

    <label>Map Layer:</label>
    <button onclick="showLayer('base')">Base Rainfall</button>
    <button onclick="showLayer('anom')">Anomaly</button>
</div>

<div class="dashboard">
    <div id="map"></div>
    <div id="chart-container">
        <div id="chart-loader"><div class="spinner"></div></div>
        <canvas id="rainChart"></canvas>
    </div>
</div>

<h3>Admin Rainfall (Event vs LTA)</h3>
<div class="table-wrapper">
<table id="data-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Dekad</th>
            <th>Event (mm)</th>
            <th>LTA (mm)</th>
            <th>Anomaly</th>
            <th>% Normal</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([-18.7, 29.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const bounds = [[-35.0044, 10.9955], [-7.9955, 41.0044]];

let rainfallLayer, anomalyLayer;
let currentLayer = "base"; // default
let chart;

/* ================= LOAD BASE RAINFALL ================= */
function loadRainfallLayer() {
    const date = document.getElementById('date').value;
    if (rainfallLayer) map.removeLayer(rainfallLayer);
    if (currentLayer !== "base") return;
    rainfallLayer = L.imageOverlay(`/api/classified_rainfall_tif/${date}`, bounds, {opacity: 0.6}).addTo(map);
}

/* ================= LOAD ANOMALY ================= */
function loadAnomalyLayer() {
    const date = document.getElementById('date').value;
    if (anomalyLayer) map.removeLayer(anomalyLayer);
    if (currentLayer !== "anom") return;
    anomalyLayer = L.imageOverlay(`/api/classified_dekadal_anomaly/${date}`, bounds, {opacity: 0.6}).addTo(map);
}

/* ================= LAYER TOGGLE ================= */
function showLayer(layerType) {
    currentLayer = layerType;
    if (rainfallLayer) map.removeLayer(rainfallLayer);
    if (anomalyLayer) map.removeLayer(anomalyLayer);

    if (layerType === "base") loadRainfallLayer();
    if (layerType === "anom") loadAnomalyLayer();

    // Button styling
    document.querySelectorAll(".form-container button").forEach(btn => btn.classList.remove("active"));
    if (layerType === "base") document.querySelector("button[onclick=\"showLayer('base')\"]").classList.add("active");
    if (layerType === "anom") document.querySelector("button[onclick=\"showLayer('anom')\"]").classList.add("active");
}

/* ================= ADMIN CLICK ================= */
fetch("/static/data/zim_admin1.geojson")
.then(r => r.json())
.then(gjson => {
    L.geoJSON(gjson, {
        style: { color: "#FF5733", weight: 2, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
            l.on("click", () => loadAdminData(f.properties.ADM1_EN));
        }
    }).addTo(map);
});

/* ================= API CALL ================= */
function loadAdminData(adm) {
    const s = start.value;
    const e = end.value;
    document.getElementById('chart-loader').style.display = 'block';

    fetch(`/api/event_vs_lta_range?start_date=${s}&end_date=${e}&adm1_name=${adm}`)
    .then(r => r.json())
    .then(json => {
        drawChart(json.data, adm);
        drawTable(json.data);
        document.getElementById('chart-loader').style.display = 'none';
    })
    .catch(err => { console.error(err); document.getElementById('chart-loader').style.display = 'none'; });
}

/* ================= CHART ================= */
function drawChart(data, adm) {
    const labels = data.map(d => d.date);
    const eventVals = data.map(d => d.event_mm);
    const ltaVals = data.map(d => d.baseline_mm);

    if (chart) chart.destroy();

    chart = new Chart(rainChart, {
        type: "line",
        data: {
            labels,
            datasets: [
                { label: `${adm} Event`, data: eventVals, borderWidth: 2, tension: 0.3 },
                { label: "Baseline (LTA)", data: ltaVals, borderDash: [6,4], borderWidth: 2, tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
            scales: { y: { title: { display: true, text: "Rainfall (mm)" } } }
        }
    });
}

/* ================= TABLE ================= */
function drawTable(data) {
    const tbody = document.querySelector("#data-table tbody");
    tbody.innerHTML = "";
    data.forEach(d => {
        const anomaly = (d.event_mm - d.baseline_mm).toFixed(1);
        const pct = d.baseline_mm > 0 ? ((d.event_mm / d.baseline_mm) * 100).toFixed(0) : "-";
        tbody.innerHTML += `
            <tr>
                <td>${d.date}</td>
                <td>${d.dekad}</td>
                <td>${d.event_mm}</td>
                <td>${d.baseline_mm}</td>
                <td>${anomaly}</td>
                <td>${pct}%</td>
            </tr>`;
    });
}

/* ================= INIT ================= */
loadRainfallLayer();
</script>
</body>
</html>
